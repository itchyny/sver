# Design

sver は依存ファイルのバージョンを計算するためのコマンドである。

## 解決したい課題

monorepo 開発における課題の一つとして CI の問題がある。
典型的にはリポジトリ一つに対して CI / CD パイプラインは多くの場合一つになる。
しかし、パイプラインがリポジトリの起動される度に、その変更と関係のないサービスのビルドが実行されてしまい余分に計算リソースや時間を浪費してしまうという事が起きる。

これを避けるために以下の対策が取られることが多い

- コミットにより影響を受けるサービスを検知するよう CI/CD Tool の設定を頑張る
- monorepo のためのビルドツールを使う

これを解決するために monorepo のためのビルドツールが多数ある。これらを採用するのには以下の課題がある。

- 新たなビルドツールを利用する必要があり、学習コストがかかる
- 既存の言語毎のデファクトスタンダードとなるビルドツールの機能が使えなくなる[^1]
- ビルドツールで対応していない言語がある、あるいはプラグインなどでの対応を行う必要がある[^2]
- 成果物やキャッシュの保存方法について monorepo 専用のビルドツールの流儀に従う必要がある

[^1] Gradle など、デファクトスタンダードなツールそのものが monorepo に向いた機能を持つこともある。
[^2] monorepo 用のビルドツールで、多言語を前提としたツールは案外少ない。

本来やりたいことは「リポジトリに変更を加えたときに、その変更が影響を及ぼすサービスやライブラリだけビルドなどのジョブを実行したい」である。
そして「リポジトリに変更を加えたときに、その変更はこのモジュールに影響を及ぼすか？」を判断するためにはモジュールをビルドするための構成要素に変化がないかを確認できればよい。

sver ではモジュールをビルドするための構成要素に一意となるハッシュを計算する仕組みを提供することによってこの問題を解決する。

参考)
https://www.graat.co.jp/blogs/ck1099bcoeud60830rf0ej0ix
https://monorepo.tools/

## バージョンの生成ロジック

バージョンは、バージョンを計算するための構成要素から計算される sha256 ハッシュの 16 進数表現とする。

バージョンにはショートとロングの 2 種類がある。
ショートバージョンは sha256 の 16 進数表現のうちの前方 12 桁とする。
ロングバージョンは sha256 の 16 進数表現の 64 桁をそのまま使う。

### 構成要素

バージョンを計算するための構成要素は以下の 4 つとする。

- バージョン計算対象の git リポジトリ上のパス
- 依存ファイルの git リポジトリ上のパス
- 依存ファイルのパーミッション
- 依存ファイルの内容

### 依存ファイルの導出について

バージョン計算対象がファイルの場合は依存ファイルは指定されたファイルのみとする。
バージョン計算対象がディレクトリの場合はそのディレクトリ配下のファイルすべてとなる。
ただし、そのディレクトリに sver.toml がある場合は以下のようにする
- excludes 指定にマッチするファイルは除外する
- dependencies 指定したディレクトリまたはファイルの依存ファイルは含む

excludes 指定にマッチしたファイルが dependencies 指定のファイルで依存ファイルに含まれる場合は依存ファイルに**含まれる**。

### sver.toml の仕様

sver.toml はトップレベルに profile があり、その配下に dependencies と excludes がある。
現時点では default profile のみが使われる。

```toml
[default]
dependencies = [
    "lib/mylib1",
    "lib/mylib2",
]
excludes = [
    "doc",
]
```
