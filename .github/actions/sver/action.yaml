name: "execute with sver"
description: "execute with sver"

inputs:
  phase:
    description: 'phase name'
    required: true
  command:
    description: 'execute command'
    required: true
  path:
    description: 'sver target path'
    required: false
    default: '.'

runs:
  using: "composite"
  steps:
    - name: Create ci-result dir
      shell: bash
      run: mkdir ci-result
    - id: calc_version
      name: calc current version
      shell: bash
      run: |
        version="$(sver calc ${{ inputs.path }})"
        echo "##[set-output name=version;]${version}"
    - name: Cache ci result
      uses: actions/cache@v3
      with:
        key: ${{ runner.os }}-ci-result-${{ steps.calc_version.outputs.version }}
        path: ci-result
    - name: Check ci-result
      id: ci_result
      shell: bash
      run: |
        echo "##[set-output name=status;]$(test -f ci-result/${{ inputs.phase }}-${{ steps.calc_version.outputs.version }}.success ; echo $?)"
    - name: execute
      if: ${{ steps.ci_result.outputs.status != 0 }}
      shell: bash
      run: "${{ inputs.command }}"
    - name: save
      shell: bash
      run: touch ci-result/${{ inputs.phase }}-${{ steps.calc_version.outputs.version }}.success
